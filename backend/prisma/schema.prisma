generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Operation {
  id    Int      @id @default(autoincrement())
  name  String   @unique
  properties Property[]
}

model PropertyType {
  id           Int      @id @default(autoincrement())
  name         String   @unique
  properties   Property[]
  housingTypes HousingType[]
  preferences  Preference[]
}

model HousingType {
  id              Int      @id @default(autoincrement())
  propertyType    PropertyType @relation(fields: [propertyTypeId], references: [id], onDelete: Cascade)
  propertyTypeId  Int
  name            String
  properties      Property[]
  preferences     Preference[]   // ← добавлено для обратной связи
}

model Property {
  id                   Int              @id @default(autoincrement())
  operation            Operation        @relation(fields: [operationId], references: [id])
  operationId          Int
  propertyType         PropertyType     @relation(fields: [propertyTypeId], references: [id])
  propertyTypeId       Int
  housingType          HousingType?     @relation(fields: [housingTypeId], references: [id])
  housingTypeId        Int?
  // Основные поля из твоего запроса
  title                String?      // Название объекта (новое поле для заголовка)
  price                Float            // Цена
  area                 Float?           // Общая площадь (дублируется totalArea)
  floor                Int?             // Этаж
  totalFloors          Int?             // Всего этажей в доме
  buildingType         String?      // Тип дома (кирпичный, монолитный, панельный)
  shortDescription     String?          // Краткое описание
  status               String           @default("active")  // Актуальность ("active", "draft", "archived")
  bargaining           Boolean?         @default(true)      // Возможность торга
  mortgagePossible     Boolean?         @default(false)     // Ипотека
  maternalCapital      Boolean?     @default(false) // Мат. капитал (новое поле)
  fullDescription      String?          // Длинное описание

  // Дополнительные параметры об объекте
  buildingDescription         String?  // Подробное описание типа дома
  yearBuilt                   Int?         // Год постройки
  yearBuiltDescription        String?  // Описание года постройки
  hasElevator                 Boolean?     // Лифты (есть ли)
  parking                     String?      // Парковка (есть ли, описание)
  environment                 String?  // Окружение (описание)
  infrastructure              String?  // Инфраструктура (описание)
  transportAccessibility      String?  // Транспортная доступность (описание)
  communications              String?  // Коммуникация (описание проводки, труб, интернета)
  renovation                  String?      // Отделка (описание, было renovation)
  legalPurity                 String?  // Юридическая чистота (описание)
  mortgageDescription         String?  // Описание ипотеки
  livingDescription           String?  // Проживание (описание)

  // Существующие поля (оставляем как есть)
  condition            String?
  roomsCount           Int?
  address              String?
  latitude             Float?
  longitude            Float?
  favorites            Favorite[]
  requests             Request[]
  images               PropertyImage[]
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  archivedAt           DateTime?
  slug                 String?          @unique
  totalArea            Float?           // Общая площадь (дублирует area)
  livingArea           Float?           // Жилая площадь
  kitchenArea          Float?           // Площадь кухни
  renovationYear       Int?
  balcony              String?
  bathroom             String?
  windows              String?
  view                 String?
  ownership            String?
  encumbrance          Boolean?         @default(false)
  readyToMove          Boolean?         @default(false)

  // Новая связь с комнатами
  rooms            Room[]       // Связь с детальными комнатами (one-to-many)
}

// Новая модель для комнат (кухня, гостиная и т.д.)
model Room {
  id          Int      @id @default(autoincrement())
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId  Int
  type        String   // Тип комнаты: "kitchen", "living_room", "bedroom", "child_room", "office", "bathroom", "balcony", "hallway", "storage"
  area        Float?   // Метраж
  description String?  // Описание
}

model User {
  id                        Int       @id @default(autoincrement())
  firstName                 String
  lastName                  String
  email                     String    @unique
  passwordHash              String
  phone                     String?   @unique   // ← добавили уникальность

  // смена email
  newEmail                  String?
  emailVerificationCode     String?
  emailVerificationExpires  DateTime?
  emailVerificationAttempts Int       @default(0)   // ← новый счётчик

  // восстановление пароля
  resetPasswordToken        String?
  resetPasswordExpires      DateTime?
  resetPasswordAttempts     Int       @default(0)   // ← новый счётчик

  isAdmin                   Boolean   @default(false)

  favorites                 Favorite[]
  preferences               Preference?
  settings                  Setting?
  requests                  Request[]

  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
}

model Favorite {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  property  Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId Int

  createdAt DateTime @default(now())

  @@unique([userId, propertyId])
}

model Preference {
  id              Int         @id @default(autoincrement())
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          Int         @unique
  propertyType    PropertyType? @relation(fields: [propertyTypeId], references: [id])
  propertyTypeId  Int?
  housingType     HousingType?  @relation(fields: [housingTypeId], references: [id])
  housingTypeId   Int?
  floorPreference String?     // "not_first", "not_last", "any"
  rooms           String?     // "studio", "1", "2", "3", "4", "5+"
  areaMin         Float?      // было Decimal? @db.Decimal(10, 2)
  areaComfort     Float?      // было Decimal? @db.Decimal(10, 2)
  areaMax         Float?      // было Decimal? @db.Decimal(10, 2)
  mortgage        String?     // "yes", "no", "considering"

  updatedAt       DateTime    @updatedAt
}

model Setting {
  id                  Int     @id @default(autoincrement())
  user                User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              Int     @unique
  notificationsEnabled Boolean @default(true)
  privacyLevel        String?  // "basic", "extended"
  twoFactorEnabled    Boolean @default(false)

  updatedAt           DateTime @updatedAt
}

model Request {
  id          Int      @id @default(autoincrement())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      Int
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId  Int
  status      String   @default("new")  // new, in_progress, closed
  message     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([propertyId])
}

model PropertyImage {
  id        Int      @id @default(autoincrement())
  property  Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId Int
  url       String
  isMain    Boolean  @default(false)
  createdAt DateTime @default(now())
}