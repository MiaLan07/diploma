generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Operation {
  id    Int      @id @default(autoincrement())
  name  String   @unique
  properties Property[]
}

model PropertyType {
  id           Int      @id @default(autoincrement())
  name         String   @unique
  properties   Property[]
  housingTypes HousingType[]
  preferences  Preference[]
}

model HousingType {
  id              Int      @id @default(autoincrement())
  propertyType    PropertyType @relation(fields: [propertyTypeId], references: [id], onDelete: Cascade)
  propertyTypeId  Int
  name            String
  properties      Property[]
  preferences     Preference[]   // ← добавлено для обратной связи
}

model Property {
  id                Int            @id @default(autoincrement())
  operation         Operation      @relation(fields: [operationId], references: [id])
  operationId       Int
  propertyType      PropertyType   @relation(fields: [propertyTypeId], references: [id])
  propertyTypeId    Int
  housingType       HousingType?   @relation(fields: [housingTypeId], references: [id])
  housingTypeId     Int?
  price             Float          // было Decimal @db.Decimal(15, 2)
  area              Float?         // было Decimal? @db.Decimal(10, 2)
  condition         String?
  parking           String?
  rooms             Int?
  floor             Int?
  hasElevator       Boolean?
  yearBuilt         Int?
  shortDescription  String?
  fullDescription   String?
  address           String?
  latitude          Float?         // было Decimal? @db.Decimal(9, 6)
  longitude         Float?         // было Decimal? @db.Decimal(9, 6)

  favorites         Favorite[]
  requests          Request[]
  images            PropertyImage[]

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  status            String         @default("active")   // "draft", "active", "archived"
  archivedAt        DateTime?

  slug              String?        @unique  // Добавлено для SEO и лучшей индексации (генерируется автоматически)

  totalArea         Float?         // общая площадь (дублирует area, но для ясности)
  livingArea        Float?         // жилая площадь
  kitchenArea       Float?         // площадь кухни

  // Этажность дома (важно для понимания 6/9, 9/17 и т.д.)
  totalFloors       Int?           // всего этажей в доме

  // Более точное состояние
  renovation        String?        // "свежий ремонт", "косметический", "требует ремонта", "дизайнерский", "без ремонта"
  renovationYear    Int?           // год последнего ремонта (если известен)

  // Дополнительные удобства / особенности (часто показывают иконками или списком)
  balcony           String?        // "балкон", "лоджия", "два балкона", "нет"
  bathroom          String?        // "совмещённый", "раздельный", "2 санузла"
  windows           String?        // "деревянные", "пластиковые", "выходят во двор", "на улицу"
  view              String?        // "во двор", "на парк", "на город", "на море"

  // Юридическая информация (очень важна для покупателей)
  ownership         String?        // "собственность", "приватизирована", "договор долевого участия"
  encumbrance       Boolean?       @default(false)   // есть ли обременение
  mortgagePossible  Boolean?       @default(false)   // можно ипотеку

  // Для отображения "можно заехать сразу", "торг уместен" и т.п.
  readyToMove       Boolean?       @default(false)   // можно сразу заехать
  bargaining        Boolean?       @default(true)    // торг уместен
}

model User {
  id                        Int       @id @default(autoincrement())
  firstName                 String
  lastName                  String
  email                     String    @unique
  passwordHash              String
  phone                     String?   @unique   // ← добавили уникальность

  // смена email
  newEmail                  String?
  emailVerificationCode     String?
  emailVerificationExpires  DateTime?
  emailVerificationAttempts Int       @default(0)   // ← новый счётчик

  // восстановление пароля
  resetPasswordToken        String?
  resetPasswordExpires      DateTime?
  resetPasswordAttempts     Int       @default(0)   // ← новый счётчик

  isAdmin                   Boolean   @default(false)

  favorites                 Favorite[]
  preferences               Preference?
  settings                  Setting?
  requests                  Request[]

  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
}

model Favorite {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  property  Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId Int

  createdAt DateTime @default(now())

  @@unique([userId, propertyId])
}

model Preference {
  id              Int         @id @default(autoincrement())
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          Int         @unique
  propertyType    PropertyType? @relation(fields: [propertyTypeId], references: [id])
  propertyTypeId  Int?
  housingType     HousingType?  @relation(fields: [housingTypeId], references: [id])
  housingTypeId   Int?
  floorPreference String?     // "not_first", "not_last", "any"
  rooms           String?     // "studio", "1", "2", "3", "4", "5+"
  areaMin         Float?      // было Decimal? @db.Decimal(10, 2)
  areaComfort     Float?      // было Decimal? @db.Decimal(10, 2)
  areaMax         Float?      // было Decimal? @db.Decimal(10, 2)
  mortgage        String?     // "yes", "no", "considering"

  updatedAt       DateTime    @updatedAt
}

model Setting {
  id                  Int     @id @default(autoincrement())
  user                User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              Int     @unique
  notificationsEnabled Boolean @default(true)
  privacyLevel        String?  // "basic", "extended"
  twoFactorEnabled    Boolean @default(false)

  updatedAt           DateTime @updatedAt
}

model Request {
  id          Int      @id @default(autoincrement())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      Int
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId  Int
  status      String   @default("new")  // new, in_progress, closed
  message     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([propertyId])
}

model PropertyImage {
  id        Int      @id @default(autoincrement())
  property  Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId Int
  url       String
  isMain    Boolean  @default(false)
  createdAt DateTime @default(now())
}