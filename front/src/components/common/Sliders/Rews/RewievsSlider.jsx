// src/components/ReviewsSlider.jsx
import React, { useState, useEffect, useCallback } from 'react';
import useEmblaCarousel from 'embla-carousel-react';
import './ReviewsSlider.css';
import { useInView } from 'react-intersection-observer';

const reviewsData = [
  {
    title: "Покупка трёхкомнатной квартиры в строящемся доме с использованием материнского капитала",
    text: "Мы с мужем боялись связываться с новостройкой, материнский капитал — столько бумажной волокиты! Но специалисты буквально взяли всё в свои руки. Нам пришлось буквально по строчкам в свои руки. Предложили на выбор 4 отличных варианта с чёткими сроками, одобрение ипотеки, самый волнительный момент, потому что нам помогли идеально собрать все документы. Всего за 1,5 месяца мы стали собственниками светлой квартиры в расстоянии",
  },
  {
    title: "Срочная продажа квартиры после переезда в другом городе",
    text: "Переехали в другой город, а квартиру продать нужно было срочно. Думал, что придётся сорваться и лететь обратно, тратить кучу времени и денег. Но оказалось, всё можно сделать удалённо. Меня приятно удивило, как быстро и качественно всё организовали. Квартиру показали так, будто она выглядит лучше, чем в жизни. Плюс никаких сюрпризов в конце. Огромное спасибо сервису, который реально онлайн работает!",
  },
  {
    title: "Покупка трёхкомнатной квартиры с материнским капиталом",
    text: "Ситуация у меня была не простая — наследство, общая квартира с родственниками, стресс. Я не верила, что смогу когда-нибудь разобраться и жить в своей отдельной квартире. Но команда не подвела! Юрист был просто ангелом — в моём любимом районе, сопровождал два с половиной месяца, всё объяснял, даже когда я звонила в 23:00. Теперь у меня есть свой угол, и я дышу полной грудью!",
  },
  {
    title: "Покупка дома у реки для постоянного проживания",
    text: "Мечтали о своём доме у воды, но боялись купить «кота в мешке». Наши агенты подошли к делу с невероятной дотошностью! Они не просто показывали дома, а буквально просвечивали их: сами инициировали проверку воды, почвы и всех коммуникаций. Когда нашли тот самый дом с выходом к реке, они предоставили нам полный кадастровый отчёт - все границы были чётко обозначены, никаких неожиданностей. Мы покупали не просто недвижимость, а уверенность в завтрашнем дне",
  },
  {
    title: "Продажа апартаментов для покупки большего жилья",
    text: "Нужно было продать апартаменты, чтобы хватило на первый взнос за квартиру для растущей семьи. Конкуренция на рынке была бешеная. Но то, как презентовали наши апартаменты, — это было выше всех похвал! 3D-тур, профессиональные фото — на их фоне предложения конкурентов просто терялись. В итоге продали всего за месяц и выручили даже чуть больше, чем планировали! Теперь наша новая квартира — во многом благодаря их грамотному продвижению",
  },
  {
    title: "Покупка квартиры от застройщика на раннем этапе строительства",
    text: "Решились купить квартиру на стадии котлована в ЖК «Звездный», хотя дрожь в коленках была — все эти истории о недостроях... Но наш агент провел такую проверку застройщика, которую, мне кажется, и спецслужбы бы оценили! Нам предоставили полный отчет, разъяснили каждый пункт ДДУ. Риски были минимизированы, и мы подписали договор со спокойной душой. И вот результат — дом сдан, мы уже делаем ремонт. Ни одной претензии!",
  },
  {
    title: "Продажа квартиры после смерти родственника",
    text: "После потери мамы мысли о продаже ее квартиры были невыносимы. Я была не в состоянии разбираться с этими бумагами, нотариусами, оценкой... Спасибо, что взяли на себя всё — от оформления наследства до поиска покупателей. Их спокойное и профессиональное сопровождение на каждом этапе позволило мне избежать множества ошибок и сберечь нервы. Квартиру продали быстро и по хорошей цене",
  },
  {
    title: "Покупка таунхауса в ипотеку для семьи с детьми",
    text: "Мы хотели переехать из тесной квартиры в свой таунхаус, но главным условием был детский сад в шаговой доступности. Учли все наши «хотелки»! Нашли именно то, что мы представляли в мечтах: тихий район, соседи с детьми, а главное — садик через дорогу. Ипотеку одобрили неожиданно быстро, и всего через 2 месяца мы заносили в наш новый дом коробки с игрушками. Счастье!",
  },
  {
    title: " Обмен квартиры с доплатой на машиноместо",
    text: "Казалось бы, что может быть сложнее, чем обменять часть недвижимости на другую? Мы ожидали месяцев ожидания и нервотрепки. Но обмен прошел как по маслу, без задержек! Самый волнительный момент — расчеты — был организован через банковскую ячейку, что было абсолютно безопасно и прозрачно. Мы остались не просто довольны, а впечатлены слаженностью работы",
  },
  {
    title: "Покупка коммерческого помещения под офис",
    text: "Покупал первое коммерческое помещение не как жилье для себя, а как инвестицию. Мне важно было, чтобы оно уже было «рабочим» и приносило доход. Команда подошла к вопросу не как простые риелторы, а как стратеги! Они предоставили анализ трафика, проверили юридические нюансы до мелочей. В итоге я купил помещение в бизнес-центре, которое уже сдано в аренду надежной компании. Это именно тот результат, на который я рассчитывал",
  },
  
];

const ReviewsSlider = () => {
  const [emblaRef, emblaApi] = useEmblaCarousel({
    loop: false,
    align: 'start',
    slidesToScroll: 1,
    dragFree: false,
  });

  const [selectedIndex, setSelectedIndex] = useState(0);

  const scrollPrev = useCallback(() => emblaApi?.scrollPrev(), [emblaApi]);
  const scrollNext = useCallback(() => emblaApi?.scrollNext(), [emblaApi]);
  const scrollTo = useCallback((index) => emblaApi?.scrollTo(index), [emblaApi]);

  const onSelect = useCallback(() => {
    if (!emblaApi) return;
    setSelectedIndex(emblaApi.selectedScrollSnap());
  }, [emblaApi]);

  useEffect(() => {
    if (!emblaApi) return;
    onSelect();
    emblaApi.on('select', onSelect);
    emblaApi.on('reInit', onSelect);
  }, [emblaApi, onSelect]);

  // Группируем по 3 отзыва на слайд
  const slides = [];
  for (let i = 0; i < reviewsData.length; i += 3) {
    slides.push(reviewsData.slice(i, i + 3));
  }

  const { ref } = useInView({
    threshold: 0.5,
    onChange: (inView) => {
      window.dispatchEvent(new CustomEvent('sectionVisible', {
        detail: { section: 'reviews', inView }
      }));
    },
  });
  
  return (
    <section ref={ref} className="reviews-section-wrapper" id='reviews'>
      <div className="reviews-section">
        <h2 className="section-title">Отзывы наших клиентов</h2>

        <div className="reviews-embla-viewport" ref={emblaRef}>
          <div className="reviews-embla-container">
            {slides.map((slideReviews, slideIndex) => (
              <div className="reviews-embla-slide" key={slideIndex}>
                <div className="reviews-grid">
                  {slideReviews.map((review, idx) => (
                    <article className="review-card" key={idx}>
                      <h3 className="review-card-title">{review.title}</h3>
                      <p className="review-card-text">{review.text}</p>
                    </article>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>

        <div className="reviews-navigation">
          <button
            className="reviews-arrow reviews-arrow--prev"
            onClick={scrollPrev}
            disabled={selectedIndex === 0}
            aria-label="Предыдущие отзывы"
          >
            ←
          </button>

          <div className="reviews-dots">
            {slides.map((_, idx) => (
              <button
                key={idx}
                className={`reviews-dot ${idx === selectedIndex ? 'reviews-dot--active' : ''}`}
                onClick={() => scrollTo(idx)}
                aria-label={`Перейти к группе отзывов ${idx + 1}`}
              />
            ))}
          </div>

          <button
            className="reviews-arrow reviews-arrow--next"
            onClick={scrollNext}
            disabled={selectedIndex === slides.length - 1}
            aria-label="Следующие отзывы"
          >
            →
          </button>
        </div>
      </div>
    </section>
  );
};

export default ReviewsSlider;